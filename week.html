<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محادثة باستخدام GitHub</title>
    <style>
        /* تنسيقات عامة */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        /* الهيدر */
        header {
            background: linear-gradient(135deg, #24292e 0%, #444d56 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        header h1 i {
            margin-left: 10px;
            color: #f0f6fc;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.85;
        }

        /* قسم الإعدادات */
        .setup-section {
            padding: 25px 30px;
            border-bottom: 1px solid #e1e4e8;
            background-color: #fafbfc;
        }

        .setup-section h2 {
            color: #24292e;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .setup-section h2 i {
            margin-left: 10px;
        }

        .setup-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e4e8;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #24292e;
            display: flex;
            align-items: center;
        }

        .form-group label i {
            margin-left: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-group input:focus {
            border-color: #0366d6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.2);
        }

        .token-info {
            display: flex;
            align-items: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #586069;
        }

        .token-info i {
            margin-left: 5px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }

        .btn-primary {
            background-color: #2ea44f;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2c974b;
        }

        .btn-secondary {
            background-color: #f6f8fa;
            color: #24292e;
            border: 1px solid #d1d5da;
        }

        .btn-secondary:hover {
            background-color: #f3f4f6;
        }

        .btn-danger {
            background-color: #d73a49;
            color: white;
        }

        .btn-danger:hover {
            background-color: #cb2431;
        }

        .instructions {
            background-color: #f1f8ff;
            padding: 18px;
            border-radius: 8px;
            border-right: 4px solid #0366d6;
        }

        .instructions h3 {
            margin-bottom: 12px;
            color: #0366d6;
            display: flex;
            align-items: center;
        }

        .instructions h3 i {
            margin-left: 10px;
        }

        .instructions ol {
            padding-right: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: #24292e;
        }

        .instructions a {
            color: #0366d6;
            text-decoration: none;
        }

        .instructions a:hover {
            text-decoration: underline;
        }

        /* قسم المحادثة */
        .chat-section {
            padding: 25px 30px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chat-header h2 {
            color: #24292e;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .chat-header h2 i {
            margin-left: 10px;
        }

        .chat-status {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        #connection-status {
            margin-left: 8px;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #dc3545;
        }

        .status-dot.connected {
            background-color: #28a745;
        }

        .chat-container {
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            overflow: hidden;
        }

        .messages-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f6f8fa;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6a737d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .message {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-right: 4px solid #0366d6;
            max-width: 80%;
        }

        .message-sender {
            font-weight: 700;
            color: #0366d6;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .message-sender i {
            margin-left: 8px;
        }

        .message-content {
            margin-bottom: 10px;
            color: #24292e;
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.85rem;
            color: #6a737d;
            text-align: left;
        }

        .message-input {
            border-top: 1px solid #e1e4e8;
            padding: 20px;
            background-color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-info i {
            font-size: 1.8rem;
            color: #586069;
            margin-left: 10px;
        }

        .user-info input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 1rem;
        }

        .input-area {
            display: flex;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 15px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }

        .input-area textarea:focus {
            border-color: #0366d6;
            outline: none;
        }

        .input-area button {
            margin-right: 10px;
            padding: 0 25px;
        }

        /* الفوتر */
        footer {
            padding: 20px 30px;
            text-align: center;
            background-color: #fafbfc;
            border-top: 1px solid #e1e4e8;
            color: #586069;
            font-size: 0.9rem;
        }

        .refresh-info {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #6a737d;
        }

        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .chat-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chat-header h2 {
                margin-bottom: 10px;
            }
            
            .chat-status {
                margin-bottom: 15px;
            }
            
            .btn {
                margin-bottom: 10px;
                width: 100%;
                margin-left: 0;
            }
            
            .input-area {
                flex-direction: column;
            }
            
            .input-area button {
                margin-right: 0;
                margin-top: 10px;
                width: 100%;
            }
            
            .message {
                max-width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-github"></i> محادثة GitHub</h1>
            <p class="subtitle">محادثة جماعية مع تخزين البيانات على مستودع GitHub</p>
        </header>

        <div class="setup-section">
            <h2><i class="fas fa-cog"></i> إعدادات الوصول إلى GitHub</h2>
            <div class="setup-form">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> اسم مستخدم GitHub</label>
                    <input type="text" id="username" placeholder="أدخل اسم مستخدم GitHub">
                </div>
                <div class="form-group">
                    <label for="repo"><i class="fas fa-database"></i> اسم المستودع</label>
                    <input type="text" id="repo" placeholder="أدخل اسم المستودع">
                </div>
                <div class="form-group">
                    <label for="token"><i class="fas fa-key"></i> رمز الوصول الشخصي (Token)</label>
                    <input type="password" id="token" placeholder="أدخل رمز الوصول الشخصي">
                    <div class="token-info">
                        <i class="fas fa-info-circle"></i>
                        <span>يجب أن يكون الرمز لديه صلاحية <strong>repo</strong></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="branch"><i class="fas fa-code-branch"></i> الفرع (Branch)</label>
                    <input type="text" id="branch" value="main" placeholder="main (الافتراضي)">
                </div>
                <button id="save-config" class="btn btn-primary">
                    <i class="fas fa-save"></i> حفظ الإعدادات
                </button>
                <button id="check-connection" class="btn btn-secondary">
                    <i class="fas fa-plug"></i> اختبار الاتصال
                </button>
            </div>
            <div class="instructions">
                <h3><i class="fas fa-question-circle"></i> تعليمات:</h3>
                <ol>
                    <li>أنشئ مستودعًا جديدًا على GitHub (يمكن أن يكون خاصًا أو عامًا)</li>
                    <li>أنشئ رمز وصول شخصي (Token) مع صلاحية <strong>repo</strong> من <a href="https://github.com/settings/tokens" target="_blank">إعدادات GitHub</a></li>
                    <li>أدخل البيانات أعلاه واضغط على "حفظ الإعدادات"</li>
                    <li>يمكن مشاركة هذه البيانات مع الآخرين للانضمام إلى نفس المحادثة</li>
                </ol>
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> المحادثة</h2>
                <div class="chat-status">
                    <span id="connection-status">غير متصل</span>
                    <span class="status-dot" id="status-dot"></span>
                </div>
                <button id="clear-chat" class="btn btn-danger">
                    <i class="fas fa-trash"></i> مسح المحادثة
                </button>
            </div>

            <div class="chat-container">
                <div class="messages-container" id="messages-container">
                    <div class="empty-state" id="empty-state">
                        <i class="fas fa-comment-slash"></i>
                        <p>لا توجد رسائل بعد. ابدأ المحادثة الآن!</p>
                    </div>
                </div>

                <div class="message-input">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <input type="text" id="sender-name" placeholder="اسمك">
                    </div>
                    <div class="input-area">
                        <textarea id="message-input" placeholder="اكتب رسالتك هنا..."></textarea>
                        <button id="send-message" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> إرسال
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>تم التطوير باستخدام GitHub API | يمكن لأي شخص يمتلك رمز الوصول مشاهدة المحادثة</p>
            <p class="refresh-info">يتم تحديث الرسائل تلقائيًا كل 10 ثوانٍ</p>
        </footer>
    </div>

    <script>
        // العناصر DOM
        const usernameInput = document.getElementById('username');
        const repoInput = document.getElementById('repo');
        const tokenInput = document.getElementById('token');
        const branchInput = document.getElementById('branch');
        const saveConfigBtn = document.getElementById('save-config');
        const checkConnectionBtn = document.getElementById('check-connection');
        const connectionStatus = document.getElementById('connection-status');
        const statusDot = document.getElementById('status-dot');
        const messagesContainer = document.getElementById('messages-container');
        const emptyState = document.getElementById('empty-state');
        const senderNameInput = document.getElementById('sender-name');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message');
        const clearChatBtn = document.getElementById('clear-chat');

        // بيانات التكوين
        let config = {
            username: '',
            repo: '',
            token: '',
            branch: 'main',
            filePath: 'chat-data.json',
            sha: null // لتتبع SHA الملف للتحديثات
        };

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            updateConnectionStatus();
            loadMessages();
            
            // تعيين تحديث تلقائي كل 10 ثواني
            setInterval(loadMessages, 10000);
        });

        // حفظ الإعدادات
        saveConfigBtn.addEventListener('click', function() {
            config.username = usernameInput.value.trim();
            config.repo = repoInput.value.trim();
            config.token = tokenInput.value.trim();
            config.branch = branchInput.value.trim() || 'main';
            
            if (!config.username || !config.repo || !config.token) {
                alert('الرجاء إدخال جميع الحقول المطلوبة');
                return;
            }
            
            saveConfig();
            updateConnectionStatus();
            alert('تم حفظ الإعدادات بنجاح');
        });

        // اختبار الاتصال
        checkConnectionBtn.addEventListener('click', async function() {
            if (!config.username || !config.repo || !config.token) {
                alert('الرجاء حفظ الإعدادات أولاً');
                return;
            }
            
            const connected = await testConnection();
            if (connected) {
                alert('الاتصال بنجاح! يمكنك الآن استخدام المحادثة.');
            } else {
                alert('فشل الاتصال. الرجاء التحقق من البيانات المدخلة.');
            }
        });

        // إرسال رسالة
        sendMessageBtn.addEventListener('click', async function() {
            await sendMessage();
        });

        // إرسال رسالة عند الضغط على Enter (مع Ctrl)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // مسح المحادثة
        clearChatBtn.addEventListener('click', function() {
            if (confirm('هل أنت متأكد من مسح جميع الرسائل؟')) {
                clearChat();
            }
        });

        // تحميل الإعدادات من localStorage
        function loadConfig() {
            const savedConfig = localStorage.getItem('githubChatConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                usernameInput.value = config.username;
                repoInput.value = config.repo;
                tokenInput.value = config.token;
                branchInput.value = config.branch;
                
                // تحميل اسم المرسل من localStorage
                const savedSender = localStorage.getItem('githubChatSender');
                if (savedSender) {
                    senderNameInput.value = savedSender;
                }
            }
        }

        // حفظ الإعدادات في localStorage
        function saveConfig() {
            localStorage.setItem('githubChatConfig', JSON.stringify(config));
            
            // حفظ اسم المرسل
            if (senderNameInput.value.trim()) {
                localStorage.setItem('githubChatSender', senderNameInput.value.trim());
            }
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus() {
            if (config.username && config.repo && config.token) {
                connectionStatus.textContent = 'متصل';
                statusDot.classList.add('connected');
            } else {
                connectionStatus.textContent = 'غير متصل';
                statusDot.classList.remove('connected');
            }
        }

        // اختبار الاتصال مع GitHub
        async function testConnection() {
            try {
                const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${config.filePath}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 200 || response.status === 404) {
                    return true; // الملف موجود أو لا يوجد (سنتعامل مع الحالتين)
                } else {
                    console.error('فشل الاتصال:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('خطأ في الاتصال:', error);
                return false;
            }
        }

        // تحميل الرسائل من GitHub
        async function loadMessages() {
            if (!config.username || !config.repo || !config.token) return;
            
            try {
                const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${config.filePath}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 200) {
                    const data = await response.json();
                    const content = atob(data.content); // فك التشفير base64
                    const messages = JSON.parse(content);
                    
                    // حفظ SHA لتحديث الملف
                    config.sha = data.sha;
                    
                    displayMessages(messages);
                    
                    // إخفاء حالة عدم وجود رسائل
                    emptyState.style.display = 'none';
                } else if (response.status === 404) {
                    // الملف غير موجود، نعرض رسالة فارغة
                    emptyState.style.display = 'flex';
                    messagesContainer.innerHTML = '';
                    messagesContainer.appendChild(emptyState);
                }
            } catch (error) {
                console.error('خطأ في تحميل الرسائل:', error);
            }
        }

        // عرض الرسائل في الواجهة
        function displayMessages(messages) {
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                emptyState.style.display = 'flex';
                messagesContainer.appendChild(emptyState);
                return;
            }
            
            // عرض الرسائل من الأقدم إلى الأحدث
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                
                const time = new Date(msg.timestamp).toLocaleString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageElement.innerHTML = `
                    <div class="message-sender">
                        <i class="fas fa-user"></i>
                        ${msg.sender}
                    </div>
                    <div class="message-content">${msg.content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // التمرير إلى الأسفل
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // إرسال رسالة جديدة
        async function sendMessage() {
            const sender = senderNameInput.value.trim();
            const content = messageInput.value.trim();
            
            if (!sender || !content) {
                alert('الرجاء إدخال اسمك ورسالتك');
                return;
            }
            
            if (!config.username || !config.repo || !config.token) {
                alert('الرجاء إعداد الاتصال أولاً');
                return;
            }
            
            try {
                // تحميل الرسائل الحالية
                let messages = [];
                let currentSha = null;
                
                try {
                    const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${config.filePath}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.status === 200) {
                        const data = await response.json();
                        const content = atob(data.content);
                        messages = JSON.parse(content);
                        currentSha = data.sha;
                    }
                } catch (error) {
                    // الملف غير موجود، سنقوم بإنشائه
                    console.log('إنشاء ملف جديد للمحادثة');
                }
                
                // إضافة الرسالة الجديدة
                const newMessage = {
                    sender: sender,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                messages.push(newMessage);
                
                // حفظ اسم المرسل في localStorage
                localStorage.setItem('githubChatSender', sender);
                
                // تحويل البيانات إلى JSON ثم base64
                const messagesJson = JSON.stringify(messages, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(messagesJson)));
                
                // إرسال البيانات إلى GitHub
                const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${config.filePath}`;
                const body = {
                    message: `أضاف رسالة جديدة: ${sender}`,
                    content: contentBase64,
                    branch: config.branch
                };
                
                // إذا كان الملف موجودًا، نضيف SHA للتحديث
                if (currentSha) {
                    body.sha = currentSha;
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    // مسح حقل الإدخال
                    messageInput.value = '';
                    
                    // تحميل الرسائل المحدثة
                    loadMessages();
                } else {
                    const errorData = await response.json();
                    alert(`فشل إرسال الرسالة: ${errorData.message || 'خطأ غير معروف'}`);
                }
            } catch (error) {
                console.error('خطأ في إرسال الرسالة:', error);
                alert('حدث خطأ أثناء إرسال الرسالة');
            }
        }

        // مسح جميع الرسائل
        async function clearChat() {
            if (!config.username || !config.repo || !config.token) {
                alert('الرجاء إعداد الاتصال أولاً');
                return;
            }
            
            try {
                // الحصول على SHA الملف الحالي
                const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${config.filePath}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 200) {
                    const data = await response.json();
                    const sha = data.sha;
                    
                    // إنشاء ملف فارغ
                    const emptyMessages = [];
                    const messagesJson = JSON.stringify(emptyMessages, null, 2);
                    const contentBase64 = btoa(unescape(encodeURIComponent(messagesJson)));
                    
                    // تحديث الملف ليصبح فارغًا
                    const updateResponse = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'مسح جميع الرسائل',
                            content: contentBase64,
                            branch: config.branch,
                            sha: sha
                        })
                    });
                    
                    if (updateResponse.ok) {
                        alert('تم مسح المحادثة بنجاح');
                        loadMessages();
                    } else {
                        alert('فشل مسح المحادثة');
                    }
                } else if (response.status === 404) {
                    alert('لا توجد محادثة لمسحها');
                }
            } catch (error) {
                console.error('خطأ في مسح المحادثة:', error);
                alert('حدث خطأ أثناء مسح المحادثة');
            }
        }
    </script>
</body>
</html>