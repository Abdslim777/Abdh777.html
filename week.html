<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± v14.5 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <style>
        :root {
            --bg: #080a0f;
            --card: #151921;
            --primary: #00d26a;
            --gold: #ffb100;
            --blue: #0095ff;
            --red: #ff4757;
            --orange: #ffa502;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: white;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }
        
        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ø³Ø­Ø¨ */
        .app-wrapper {
            height: 100vh;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        section {
            height: 100vh;
            width: 100%;
            scroll-snap-align: start;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Ø§Ù„Ø´Ø§Ø´Ø© 1: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .app-title {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .status-pill {
            background: rgba(0, 210, 106, 0.1);
            color: var(--primary);
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(0, 210, 106, 0.3);
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .main-stat {
            background: linear-gradient(145deg, #151921, #0d1117);
            border-radius: 30px;
            padding: 40px 20px;
            text-align: center;
            border: 1px solid #2d333b;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .counter {
            font-size: 4rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 0 20px var(--blue);
            margin: 20px 0;
            font-family: 'Arial Black', sans-serif;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
            padding: 0 10px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            color: #8b949e;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
        }
        
        .stat-value.found {
            color: var(--gold);
        }
        
        /* Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„ÙƒÙ†ÙˆØ² */
        .treasure-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .refresh-btn {
            background: rgba(255, 177, 0, 0.1);
            color: var(--gold);
            border: 1px solid rgba(255, 177, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: rgba(255, 177, 0, 0.2);
        }
        
        .treasure-container {
            flex: 1;
            overflow-y: auto;
            background: #0d1117;
            border-radius: 15px;
            padding: 10px;
            border: 1px solid var(--gold);
        }
        
        .wallet-card {
            background: linear-gradient(145deg, #1c2128, #151921);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-right: 5px solid var(--gold);
            transition: transform 0.3s;
            position: relative;
        }
        
        .wallet-card:hover {
            transform: translateX(-5px);
        }
        
        .wallet-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--gold);
            color: black;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-badge {
            background: rgba(0, 149, 255, 0.1);
            color: var(--blue);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            border: 1px solid rgba(0, 149, 255, 0.3);
        }
        
        .chat-wrap {
            flex: 1;
            background: #000;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #30363d;
        }
        
        #chatBox {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .msg {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s;
        }
        
        .msg.self {
            background: linear-gradient(135deg, #0095ff, #0066cc);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .msg.other {
            background: linear-gradient(135deg, #2d333b, #1c2128);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .msg-user {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            display: block;
        }
        
        .msg-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-align: right;
            margin-top: 5px;
        }
        
        .chat-form {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #1c2128;
            border-top: 1px solid #30363d;
        }
        
        input {
            flex: 1;
            background: #0d1117;
            border: 2px solid #30363d;
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            outline: none;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus {
            border-color: var(--blue);
        }
        
        .btn-send {
            background: linear-gradient(135deg, var(--blue), #0066cc);
            border: none;
            color: white;
            padding: 0 25px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
        }
        
        .btn-send:hover {
            background: linear-gradient(135deg, #0066cc, var(--blue));
            transform: translateY(-2px);
        }
        
        .btn-send:active {
            transform: translateY(0);
        }
        
        .nav-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #555;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            animation: bounce 2s infinite;
        }
        
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--blue));
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0d1117;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--blue);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            background: rgba(255, 71, 87, 0.9);
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        
        .alert.success {
            background: rgba(0, 210, 106, 0.9);
        }
        
        .alert.warning {
            background: rgba(255, 165, 2, 0.9);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Ù†Ø³Ø®Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            .counter { font-size: 3rem; }
            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            .btn-send { min-width: 60px; padding: 0 15px; }
            .nav-hint { display: none; }
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <section id="screen1">
        <div class="header">
            <h1 class="app-title">ğŸš€ Ø±Ø§Ø¯Ø§Ø± ETH v14.5</h1>
            <div id="connectionStatus" class="status-pill">
                <span class="loading-dot"></span>
                <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
        </div>
        
        <div class="main-stat">
            <h2 style="margin:0; font-size: 1.2rem; color: #8b949e; margin-bottom: 10px;">Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„ÙØ­Øµ</h2>
            <div class="counter" id="globalIdx">0</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">ğŸ”„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙØ­Øµ</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ğŸ’° Ø§Ù„ÙƒÙ†ÙˆØ² Ø§Ù„Ù…ÙƒØªØ´ÙØ©</div>
                    <div class="stat-value found" id="foundCount">0</div>
                </div>
            </div>
            
            <div style="margin-top: 30px; font-size: 14px; color: var(--primary);" id="autoInfo">
                <div id="scanSpeed">Ø§Ù„Ø³Ø±Ø¹Ø©: 0 Ø¹Ù†ÙˆØ§Ù†/Ø«Ø§Ù†ÙŠØ©</div>
                <div id="scanStatus">âš¡ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...</div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button id="btnPause" class="refresh-btn" style="display: none;">
                    â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙØ­Øµ
                </button>
                <button id="btnResume" class="refresh-btn" style="display: none;">
                    â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ÙØ­Øµ
                </button>
            </div>
        </div>
    </section>

    <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„ÙƒÙ†ÙˆØ² -->
    <section id="screen2">
        <div class="treasure-header">
            <h2 style="color:var(--gold);">ğŸ’ Ø§Ù„ÙƒÙ†ÙˆØ² Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h2>
            <button class="refresh-btn" onclick="refreshTreasures()">
                ğŸ”„ ØªØ­Ø¯ÙŠØ«
            </button>
        </div>
        
        <div class="treasure-container" id="treasureList">
            <div style="text-align: center; padding: 40px 20px; color: #555;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”</div>
                <h3 style="color: #8b949e; margin-bottom: 10px;">Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯</h3>
                <p style="color: #666; font-size: 14px;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£ÙŠ Ø¹Ù†ÙˆØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯</p>
            </div>
        </div>
    </section>

    <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <section id="screen3">
        <div class="chat-header">
            <h2 style="color:var(--blue);">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h2>
            <div class="user-badge" id="userBadge">Ø£Ù†Øª: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        
        <div class="chat-wrap">
            <div id="chatBox">
                <div style="text-align: center; padding: 20px; color: #666;">
                    Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹!<br>
                    <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù‡Ù†Ø§</small>
                </div>
            </div>
            <div class="chat-form">
                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..." autocomplete="off">
                <button class="btn-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </section>
</div>

<div class="nav-hint">Ø§Ø³Ø­Ø¨ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª â†•ï¸</div>

<script>
    // ============= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =============
    const CONFIG = {
        FIREBASE_URL: "https://radar-v14-final-default-rtdb.firebaseio.com/",
        ADDRESS_FILE: "addresses.txt",
        BATCH_SIZE: 3,
        DELAY_BETWEEN_BATCHES: 3000,
        DELAY_BETWEEN_REQUESTS: 500,
        MAX_RETRIES: 3,
        AUTO_SAVE_INTERVAL: 30000
    };

    // ============= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª =============
    let addresses = [];
    let currentIdx = 0;
    let isProcessing = false;
    let isPaused = false;
    let scanStartTime = null;
    let addressesProcessed = 0;
    let processingInterval = null;
    let lastSaveTime = Date.now();
    
    // ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯
    const userName = "Ù…Ø³ØªØ®Ø¯Ù…_" + Math.floor(1000 + Math.random() * 9000);
    document.getElementById('userBadge').textContent = `Ø£Ù†Øª: ${userName}`;
    
    // Ù‚Ø§Ø¦Ù…Ø© RPCs Ù…ÙˆØ«ÙˆÙ‚Ø©
    const RPC_PROVIDERS = [
        { name: "Ankr", url: "https://rpc.ankr.com/eth" },
        { name: "LlamaRPC", url: "https://eth.llamarpc.com" },
        { name: "BlastAPI", url: "https://eth-mainnet.public.blastapi.io" },
        { name: "PublicNode", url: "https://ethereum.publicnode.com" },
        { name: "1RPC", url: "https://1rpc.io/eth" },
        { name: "Cloudflare", url: "https://cloudflare-eth.com" }
    ];

    // ============= Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =============
    let db;
    try {
        const firebaseConfig = { databaseURL: CONFIG.FIREBASE_URL };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.database();
        updateStatus("Ù…ØªØµÙ„ Ø¨Ù€ Firebase âœ…", "success");
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase:", error);
        showAlert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    }

    // ============= Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© =============
    function updateStatus(text, type = "info") {
        const statusEl = document.getElementById('statusText');
        const statusPill = document.getElementById('connectionStatus');
        
        statusEl.textContent = text;
        
        switch(type) {
            case "success":
                statusPill.style.background = "rgba(0, 210, 106, 0.1)";
                statusPill.style.color = "var(--primary)";
                break;
            case "error":
                statusPill.style.background = "rgba(255, 71, 87, 0.1)";
                statusPill.style.color = "var(--red)";
                break;
            case "warning":
                statusPill.style.background = "rgba(255, 165, 2, 0.1)";
                statusPill.style.color = "var(--orange)";
                break;
        }
    }

    function showAlert(message, type = "error") {
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.innerHTML = `
            <span>${type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'âŒ'}</span>
            <span>${message}</span>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    function updateProgress() {
        if (addresses.length === 0) return;
        
        const progress = (currentIdx / addresses.length) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        
        // ØªØ­Ø¯ÙŠØ« Ø³Ø±Ø¹Ø© Ø§Ù„ÙØ­Øµ
        if (scanStartTime && addressesProcessed > 0) {
            const elapsed = (Date.now() - scanStartTime) / 1000;
            const speed = (addressesProcessed / elapsed).toFixed(1);
            document.getElementById('scanSpeed').textContent = `Ø§Ù„Ø³Ø±Ø¹Ø©: ${speed} Ø¹Ù†ÙˆØ§Ù†/Ø«Ø§Ù†ÙŠØ©`;
        }
    }

    // ============= Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =============
    function setupFirebaseListeners() {
        if (!db) return;
        
        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        db.ref('global_idx').on('value', (snapshot) => {
            const idx = snapshot.val();
            if (idx !== null && idx !== undefined) {
                currentIdx = parseInt(idx);
                document.getElementById('globalIdx').textContent = currentIdx.toLocaleString();
                updateProgress();
            }
        }, (error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¤Ø´Ø±:", error);
            updateStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", "error");
        });

        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„ÙƒÙ†ÙˆØ² Ø§Ù„Ù…ÙƒØªØ´ÙØ©
        db.ref('found').on('value', (snapshot) => {
            const listEl = document.getElementById('treasureList');
            const data = snapshot.val();
            
            if (data && typeof data === 'object') {
                const foundCount = Object.keys(data).length;
                document.getElementById('foundCount').textContent = foundCount;
                
                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                const treasures = Object.entries(data)
                    .sort(([,a], [,b]) => (b.timestamp || 0) - (a.timestamp || 0))
                    .slice(0, 50);
                
                listEl.innerHTML = '';
                
                treasures.forEach(([key, treasure], index) => {
                    if (!treasure || !treasure.addr) return;
                    
                    const div = document.createElement('div');
                    div.className = 'wallet-card';
                    div.innerHTML = `
                        <div class="wallet-badge">#${index + 1}</div>
                        <b style="color:var(--gold); font-size: 18px;">ğŸ’° ${treasure.bal || '0'} ETH</b>
                        <div style="margin: 8px 0;">
                            <small style="color:#8b949e; word-break:break-all; font-family: monospace;">
                                ${treasure.addr}
                            </small>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <small style="color:var(--blue);">
                                ğŸ‘¤ ${treasure.by || 'Ù…Ø¬Ù‡ÙˆÙ„'}
                            </small>
                            <small style="color:#666;">
                                ${treasure.timestamp ? new Date(treasure.timestamp).toLocaleTimeString('ar-EG') : ''}
                            </small>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            } else {
                document.getElementById('foundCount').textContent = '0';
            }
        });

        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        db.ref('chat').limitToLast(50).on('child_added', (snapshot) => {
            const chatData = snapshot.val();
            if (!chatData || !chatData.u || !chatData.m) return;
            
            const chatBox = document.getElementById('chatBox');
            const isSelf = chatData.u === userName;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${isSelf ? 'self' : 'other'}`;
            msgDiv.innerHTML = `
                <span class="msg-user">${chatData.u}</span>
                <div>${escapeHtml(chatData.m)}</div>
                <div class="msg-time">
                    ${chatData.time ? new Date(chatData.time).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) : 'Ø§Ù„Ø¢Ù†'}
                </div>
            `;
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† =============
    async function loadAddresses() {
        updateStatus("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†...", "info");
        
        try {
            const response = await fetch(CONFIG.ADDRESS_FILE);
            
            if (!response.ok) {
                throw new Error(`Ø®Ø·Ø£ ${response.status}: ${response.statusText}`);
            }
            
            const text = await response.text();
            
            // ØªØ­Ù„ÙŠÙ„ ÙˆØªÙ†Ù‚ÙŠØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            addresses = text
                .split(/[\s,\n\r]+/)
                .map(addr => addr.trim().toLowerCase())
                .filter(addr => {
                    try {
                        return ethers.utils.isAddress(addr) && 
                               addr.startsWith('0x') && 
                               addr.length === 42;
                    } catch {
                        return false;
                    }
                })
                .filter((addr, index, self) => self.indexOf(addr) === index);
            
            if (addresses.length === 0) {
                throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ÙˆÙŠÙ† ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù");
            }
            
            document.getElementById('totalCount').textContent = 
                Math.max(0, addresses.length - currentIdx).toLocaleString();
            
            updateStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${addresses.length.toLocaleString()} Ø¹Ù†ÙˆØ§Ù† âœ…`, "success");
            
            // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            localStorage.setItem('eth_radar_addresses', JSON.stringify(addresses));
            localStorage.setItem('eth_radar_count', addresses.length.toString());
            
            return true;
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†:", error);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            try {
                const saved = localStorage.getItem('eth_radar_addresses');
                if (saved) {
                    addresses = JSON.parse(saved);
                    updateStatus(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ${addresses.length} Ø¹Ù†ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©`, "warning");
                    return true;
                }
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
            }
            
            showAlert("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†", "error");
            updateStatus("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†", "error");
            return false;
        }
    }

    // ============= ÙØ­Øµ Ø§Ù„Ø£Ø±ØµØ¯Ø© =============
    async function checkBalance(address) {
        for (let i = 0; i < RPC_PROVIDERS.length; i++) {
            for (let retry = 0; retry < CONFIG.MAX_RETRIES; retry++) {
                try {
                    const provider = new ethers.providers.JsonRpcProvider(
                        RPC_PROVIDERS[i].url,
                        { name: 'homestead', chainId: 1 }
                    );
                    
                    provider.timeout = 10000;
                    
                    const balance = await provider.getBalance(address);
                    
                    if (balance && balance.gt(0)) {
                        const formatted = ethers.utils.formatEther(balance);
                        return {
                            success: true,
                            balance: parseFloat(formatted).toFixed(6),
                            provider: RPC_PROVIDERS[i].name
                        };
                    }
                    
                    return { success: true, balance: null };
                    
                } catch (error) {
                    if (retry === CONFIG.MAX_RETRIES - 1 && i === RPC_PROVIDERS.length - 1) {
                        console.error(`ÙØ´Ù„ ÙØ­Øµ ${address}:`, error);
                        return { success: false, error: error.message };
                    }
                    await sleep(1000 * (retry + 1));
                }
            }
        }
        
        return { success: false, error: "Ø¬Ù…ÙŠØ¹ Ù…Ø²ÙˆØ¯Ø§Øª RPC ÙØ´Ù„Øª" };
    }

    async function processBatch() {
        if (isProcessing || isPaused || !addresses || currentIdx >= addresses.length) {
            return;
        }
        
        isProcessing = true;
        document.getElementById('scanStatus').textContent = "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...";
        
        try {
            const startIdx = currentIdx;
            const endIdx = Math.min(startIdx + CONFIG.BATCH_SIZE, addresses.length);
            const batch = addresses.slice(startIdx, endIdx);
            
            for (const address of batch) {
                if (isPaused) break;
                
                const result = await checkBalance(address);
                
                if (result.success && result.balance) {
                    // Ø­ÙØ¸ Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù…ÙƒØªØ´Ù
                    await db.ref('found').push({
                        addr: address,
                        bal: result.balance,
                        by: userName,
                        timestamp: Date.now(),
                        provider: result.provider
                    });
                    
                    showAlert(`ğŸ’° ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${result.balance} ETH!`, "success");
                }
                
                addressesProcessed++;
                await sleep(CONFIG.DELAY_BETWEEN_REQUESTS);
            }
            
            if (!isPaused) {
                currentIdx = endIdx;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø± ÙÙŠ Firebase
                await db.ref('global_idx').set(currentIdx);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                document.getElementById('totalCount').textContent = 
                    Math.max(0, addresses.length - currentIdx).toLocaleString();
                
                updateProgress();
                
                // Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                if (Date.now() - lastSaveTime > CONFIG.AUTO_SAVE_INTERVAL) {
                    localStorage.setItem('eth_radar_currentIdx', currentIdx.toString());
                    lastSaveTime = Date.now();
                }
            }
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø©:", error);
            showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ", "error");
        } finally {
            isProcessing = false;
            
            if (!isPaused && currentIdx < addresses.length) {
                document.getElementById('scanStatus').textContent = "âš¡ Ø§Ù„ÙØ­Øµ ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹";
                setTimeout(processBatch, CONFIG.DELAY_BETWEEN_BATCHES);
            } else if (currentIdx >= addresses.length) {
                document.getElementById('scanStatus').textContent = "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­!";
                document.getElementById('scanStatus').style.color = "var(--primary)";
            }
        }
    }

    function startScanning() {
        if (scanStartTime === null) {
            scanStartTime = Date.now();
        }
        
        isPaused = false;
        document.getElementById('btnPause').style.display = 'inline-block';
        document.getElementById('btnResume').style.display = 'none';
        document.getElementById('scanStatus').textContent = "âš¡ Ø§Ù„ÙØ­Øµ ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹";
        
        processBatch();
    }

    function pauseScanning() {
        isPaused = true;
        document.getElementById('btnPause').style.display = 'none';
        document.getElementById('btnResume').style.display = 'inline-block';
        document.getElementById('scanStatus').textContent = "â¸ï¸ Ø§Ù„ÙØ­Øµ Ù…ØªÙˆÙ‚Ù";
        document.getElementById('scanStatus').style.color = "var(--orange)";
    }

    // ============= Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© =============
    async function sendChat() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message || !db) return;
        
        if (message.length > 500) {
            showAlert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500 Ø­Ø±Ù)", "warning");
            return;
        }
        
        if (message.length < 1) {
            showAlert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ©", "warning");
            return;
        }
        
        try {
            await db.ref('chat').push({
                u: userName,
                m: message,
                time: Date.now()
            });
            
            input.value = "";
            input.focus();
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error);
            showAlert("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©", "error");
        }
    }

    function refreshTreasures() {
        const listEl = document.getElementById('treasureList');
        listEl.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #555;">
                <div class="loading-dot" style="margin: 0 auto 20px; width: 40px; height: 40px;"></div>
                <h3 style="color: #8b949e; margin-bottom: 10px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</h3>
            </div>
        `;
        
        setTimeout(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (db) {
                db.ref('found').once('value').then(() => {
                    showAlert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ†ÙˆØ²", "success");
                });
            }
        }, 1000);
    }

    // ============= Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =============
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =============
    async function init() {
        try {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Firebase
            setupFirebaseListeners();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            const loaded = await loadAddresses();
            if (!loaded) return;
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
            const savedIdx = localStorage.getItem('eth_radar_currentIdx');
            if (savedIdx) {
                const parsed = parseInt(savedIdx);
                if (!isNaN(parsed) && parsed < addresses.length) {
                    currentIdx = parsed;
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateProgress();
            document.getElementById('totalCount').textContent = 
                Math.max(0, addresses.length - currentIdx).toLocaleString();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
            document.getElementById('btnPause').onclick = pauseScanning;
            document.getElementById('btnResume').onclick = startScanning;
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChat();
                }
            });
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
            setTimeout(startScanning, 2000);
            
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", error);
            showAlert("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", "error");
            updateStatus("ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„", "error");
        }
    }

    // ============= ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =============
    window.addEventListener('load', init);
    
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', () => {
        if (addresses.length > 0) {
            localStorage.setItem('eth_radar_currentIdx', currentIdx.toString());
        }
    });
</script>
</body>
</html>