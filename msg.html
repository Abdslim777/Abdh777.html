<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSG-GT | المحادثة الذكية المشفرة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
        <div class="glass p-8 rounded-2xl shadow-2xl w-96 text-center">
            <h1 class="text-2xl font-bold mb-6 text-blue-400">MSG-GT V2.5</h1>
            <p class="mb-4 text-sm text-slate-400">أدخل كلمة المرور لفك تشفير بياناتك</p>
            <input type="password" id="master-password" class="w-full p-3 rounded bg-slate-800 border border-slate-700 mb-4 focus:outline-none focus:border-blue-500" placeholder="كلمة المرور...">
            <button onclick="initApp()" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded font-bold transition">دخول آمن</button>
        </div>
    </div>

    <header class="p-4 glass flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <h2 class="font-bold text-lg">محادثات GitHub الذكية</h2>
        </div>
        <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300">خروج آمن</button>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="text-center text-slate-500 text-sm mt-10">بداية المحادثة المشفرة (نهاية إلى نهاية)</div>
    </main>

    <footer class="p-4 glass">
        <div class="max-w-4xl mx-auto flex gap-2">
            <input type="text" id="user-input" class="flex-1 p-3 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:border-blue-500" placeholder="اكتب رسالتك هنا...">
            <button onclick="sendMessage()" class="bg-blue-600 p-3 rounded-xl px-6 hover:bg-blue-700 transition">إرسال</button>
        </div>
    </footer>

    <script>
        let cryptoKey = null;

        // دالة إنشاء مفتاح التشفير من كلمة المرور
        async function deriveKey(password) {
            const encoder = new TextEncoder();
            const baseKey = await crypto.subtle.importKey("raw", encoder.encode(password), "PBKDF2", false, ["deriveKey"]);
            return crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: encoder.encode("msg-gt-salt"), iterations: 100000, hash: "SHA-256" },
                baseKey,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        // تشفير النص
        async function encryptData(text) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(text);
            const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, encoded);
            return { b64: btoa(String.fromCharCode(...new Uint8Array(encrypted))), iv: btoa(String.fromCharCode(...iv)) };
        }

        // بدء التطبيق
        async function initApp() {
            const pw = document.getElementById('master-password').value;
            if (!pw) return alert("يرجى إدخال كلمة المرور");
            
            try {
                cryptoKey = await deriveKey(pw);
                document.getElementById('login-screen').classList.add('hidden');
                loadHistory();
            } catch (e) {
                alert("خطأ في المفتاح!");
            }
        }

        // إرسال رسالة (محاكاة الذكاء الاصطناعي)
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            addMessageToUI('user', text);
            input.value = '';

            // حفظ الرسالة مشفرة
            const encrypted = await encryptData(text);
            saveToLocal(encrypted);

            // محاكاة رد النظام (تجريبي)
            setTimeout(() => {
                addMessageToUI('ai', "تم استلام رسالتك وتشفيرها بنجاح في النظام المحلي.");
            }, 1000);
        }

        function addMessageToUI(sender, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-start' : 'justify-end'}`;
            div.innerHTML = `
                <div class="${sender === 'user' ? 'bg-blue-700' : 'bg-slate-700'} p-3 rounded-2xl max-w-[80%] shadow-md">
                    <p class="text-sm">${text}</p>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function saveToLocal(data) {
            let history = JSON.parse(localStorage.getItem('chat_history') || '[]');
            history.push(data);
            localStorage.setItem('chat_history', JSON.stringify(history));
        }

        function logout() {
            location.reload();
        }

        function loadHistory() {
            // ملاحظة: لفك التشفير وعرض السجل نحتاج لدالة decrypt (يمكن إضافتها في المرحلة القادمة)
            console.log("تم تحميل النظام.. البيانات القديمة مخزنة بشكل مشفر.");
        }
    </script>
</body>
</html>
